@echo off
REM =====================================================================
REM migrate.bat — универсальный помощник для миграций Django на Windows
REM ---------------------------------------------------------------------
REM Назначение:
REM   Упрощает выполнение команд makemigrations и migrate из корня проекта.
REM
REM Использование:
REM     migrate.bat                 → makemigrations (всем) + migrate
REM     migrate.bat all             → то же, что без аргументов
REM     migrate.bat app_name        → makemigrations только для указанного приложения
REM     migrate.bat app_name --fake-initial
REM     migrate.bat all --fake-initial
REM ---------------------------------------------------------------------
REM Особенности:
REM   • Автоматически определяет, установлен ли Poetry и есть ли pyproject.toml.
REM     Если да — использует "poetry run python", иначе обычный "python".
REM   • Кодировка вывода: UTF-8
REM   • Подробные сообщения и защита от ошибок
REM =====================================================================

setlocal ENABLEDELAYEDEXPANSION
chcp 65001 >nul

REM Перейти в каталог, где лежит сам скрипт (обычно — корень проекта)
pushd "%~dp0"

REM ------------------------------------------------------------
REM Проверяем наличие manage.py
REM ------------------------------------------------------------
if not exist "manage.py" (
  echo ❌ Файл manage.py не найден в текущей директории:
  echo    %CD%
  echo Убедитесь, что вы запускаете скрипт из корня Django-проекта.
  popd
  exit /b 1
)

REM ------------------------------------------------------------
REM Определяем, какую команду Python использовать (Poetry или обычный)
REM ------------------------------------------------------------
set "PY_CMD=python"
where poetry >nul 2>nul
if %ERRORLEVEL%==0 (
  if exist "pyproject.toml" (
    set "PY_CMD=poetry run python"
  )
)

REM ------------------------------------------------------------
REM Разбор аргументов
REM ------------------------------------------------------------
set "TARGET=%~1"
shift
set "EXTRA=%*"

echo.
echo ===============================================
echo ▶ Django миграции (команда: %PY_CMD%)
echo ===============================================
echo.

REM ------------------------------------------------------------
REM Проверяем конфигурацию проекта
REM ------------------------------------------------------------
echo ▶ Проверка конфигурации Django...
%PY_CMD% manage.py check || goto :error

REM ------------------------------------------------------------
REM Создание миграций
REM ------------------------------------------------------------
if /I "%TARGET%"=="all" (
  echo ▶ Создаём миграции для всех приложений...
  %PY_CMD% manage.py makemigrations || goto :error
) else if "%TARGET%"=="" (
  echo ▶ Создаём миграции для всех приложений...
  %PY_CMD% manage.py makemigrations || goto :error
) else (
  echo ▶ Создаём миграции для приложения "%TARGET%"...
  %PY_CMD% manage.py makemigrations "%TARGET%" || goto :error
)

REM ------------------------------------------------------------
REM Применение миграций
REM ------------------------------------------------------------
echo ▶ Применяем миграции %EXTRA%
%PY_CMD% manage.py migrate %EXTRA% || goto :error

REM ------------------------------------------------------------
REM Выводим список миграций для контроля
REM ------------------------------------------------------------
echo.
echo ▶ Список миграций (актуальное состояние):
%PY_CMD% manage.py showmigrations
echo.
echo ✅ Все миграции успешно применены.
echo.

popd
exit /b 0

REM ------------------------------------------------------------
REM Обработка ошибок
REM ------------------------------------------------------------
:error
echo.
echo ❌ Ошибка при выполнении миграций!
echo Проверьте сообщения выше — возможно, отсутствует БД или есть ошибки в моделях.
popd
exit /b 1